{% extends "base.html" %}

{% block title %}{{ symbol }} - Crypto Monitor{% endblock %}

{% block extra_css %}
<style>
    /* Fond noir pour la page de détails du token */
    body {
        background: #000000 !important;
    }
    
    /* Ajuster les cartes pour le mode dark */
    .card {
        background: #1a1a1a !important;
        border: 1px solid #2a2a2a !important;
    }
    
    .card-header {
        background: #0d0d0d !important;
        border-bottom: 1px solid #2a2a2a !important;
    }
    
    /* Texte clair pour la lisibilité */
    body, .card, .card-body, .card-header, h1, h2, h3, h4, h5, h6, p, small {
        color: #ffffff !important;
    }
    
    .text-muted {
        color: #888888 !important;
    }
    
    /* Breadcrumb adapté */
    .breadcrumb {
        background: #1a1a1a !important;
        border: 1px solid #2a2a2a !important;
    }
    
    .breadcrumb-item a {
        color: #6366f1 !important;
    }
    
    .breadcrumb-item.active {
        color: #ffffff !important;
    }
    
    /* Tables en mode dark */
    .table {
        color: #ffffff !important;
    }
    
    .table thead th {
        border-color: #2a2a2a !important;
        color: #ffffff !important;
    }
    
    .table td, .table th {
        border-color: #2a2a2a !important;
    }
    
    /* Boutons et formulaires */
    .form-control, .form-select {
        background: #2a2a2a !important;
        border-color: #3a3a3a !important;
        color: #ffffff !important;
    }
    
    .modal-content {
        background: #1a1a1a !important;
        border: 1px solid #2a2a2a !important;
    }
    
    .modal-header, .modal-footer {
        border-color: #2a2a2a !important;
    }
    
    /* Bordures des sections */
    .border {
        border-color: #2a2a2a !important;
    }
    
    /* Container principal */
    .container {
        background: transparent !important;
    }
    
    /* Breadcrumb moderne */
    .modern-breadcrumb {
        background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%) !important;
        border: 1px solid #3a3a3a !important;
        border-radius: 12px !important;
        padding: 1rem 1.5rem !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .modern-breadcrumb .breadcrumb-item {
        font-size: 1rem;
        font-weight: 500;
    }
    
    .modern-breadcrumb .breadcrumb-item + .breadcrumb-item::before {
        content: "›";
        color: #6366f1;
        font-size: 1.3rem;
        font-weight: bold;
    }
    
    .modern-breadcrumb .breadcrumb-item a {
        color: #8b92ff !important;
        transition: all 0.3s ease;
        text-decoration: none;
    }
    
    .modern-breadcrumb .breadcrumb-item a:hover {
        color: #6366f1 !important;
        text-shadow: 0 0 8px rgba(99, 102, 241, 0.5);
    }
    
    .modern-breadcrumb .breadcrumb-item.active {
        color: #ffffff !important;
        font-weight: 600;
    }
    
    /* Tables modernes pour le carnet d'ordres - Style épuré comme paires similaires */
    .order-book-card {
        background: #2a2a2a !important;
        border: 1px solid #3a3a3a !important;
        border-radius: 16px !important;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .order-book-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(99, 102, 241, 0.2);
    }
    
    .order-book-card .card-header {
        background: #1f1f1f !important;
        border-bottom: 1px solid #3a3a3a !important;
        padding: 1.25rem 1.5rem !important;
    }
    
    .order-book-card .card-body {
        background: #2a2a2a !important;
    }
    
    .order-book-table {
        margin: 0 !important;
        background: transparent !important;
    }
    
    .order-book-table thead {
        background: #000000 !important;
    }
    
    .order-book-table thead th {
        padding: 0.875rem 1rem !important;
        font-weight: 600 !important;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 1px;
        border: none !important;
        color: #ffffff !important;
        background: #000000 !important;
    }
    
    .order-book-table tbody td {
        padding: 0.625rem 1rem !important;
        border-color: #333333 !important;
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
        background: #2a2a2a !important;
    }
    
    .order-book-table tbody tr {
        transition: background-color 0.2s ease;
        border-bottom: 1px solid #333333 !important;
    }
    
    .order-book-table tbody tr:hover {
        background-color: #323232 !important;
    }
    
    .order-book-table tbody tr:last-child {
        border-bottom: none !important;
    }
    
    /* Couleurs vives pour les prix du carnet d'ordres */
    .order-book-table .price-up {
        color: #10b981 !important;
        font-weight: 700 !important;
    }
    
    .order-book-table .price-down {
        color: #ef4444 !important;
        font-weight: 700 !important;
    }
    
    /* Prix des transactions - première colonne avec fond noir */
    .transactions-price {
        background: #000000 !important;
        color: #ffffff !important;
        font-weight: 600 !important;
    }
    
    /* Quantités en blanc pour tous les tableaux */
    .order-book-table tbody td:not(.price-up):not(.price-down):not(.transactions-price) {
        color: #ffffff !important;
    }
    
    .order-divider {
        height: 1px;
        background: linear-gradient(90deg, transparent, #444444, transparent);
        margin: 1rem 0;
    }
    
    /* Sections d'en-tête pour Achats/Ventes */
    .order-section-header {
        background: #252525 !important;
        padding: 0.75rem 1rem !important;
        border-bottom: 1px solid #333333 !important;
    }
    
    .order-section-header .price-up {
        color: #10b981 !important;
    }
    
    .order-section-header .price-down {
        color: #ef4444 !important;
    }
    
    /* Style pour les paires similaires (référence) */
    .similar-pairs-card {
        background: #2a2a2a !important;
        border: 1px solid #3a3a3a !important;
        border-radius: 12px !important;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .similar-pairs-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(99, 102, 241, 0.2);
    }
    
    /* Style pour le sélecteur d'intervalle */
    .btn-outline-primary {
        border-color: #6366f1 !important;
        color: #8b92ff !important;
        background: transparent !important;
    }
    
    .btn-outline-primary:hover,
    .btn-outline-primary:focus,
    .btn-check:checked + .btn-outline-primary {
        background: #6366f1 !important;
        border-color: #6366f1 !important;
        color: #ffffff !important;
        box-shadow: 0 0 8px rgba(99, 102, 241, 0.5) !important;
    }
    
    .btn-group .btn-check:checked + .btn-outline-primary {
        z-index: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- En-tête moderne -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb modern-breadcrumb mb-0">
                    <li class="breadcrumb-item">
                        <a href="{% url 'home:index' %}">
                            <i class="bi bi-house-door"></i> Accueil
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{% url 'search:index' %}">
                            <i class="bi bi-search"></i> Recherche
                        </a>
                    </li>
                    <li class="breadcrumb-item active">
                        <i class="bi bi-currency-exchange"></i> {{ symbol }}
                    </li>
                </ol>
            </nav>
        </div>
    </div>
    
    <!-- Informations principales -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-4">
                        <div>
                            <h2 class="mb-2">{{ symbol }}</h2>
                            <h3 class="mb-0">${{ current_price_formatted }}</h3>
                        </div>
                        <div class="text-end">
                            <button class="btn btn-primary mb-2" onclick="addToWatchlist('{{ symbol }}')">
                                <i class="bi bi-star"></i> Watchlist
                            </button>
                            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addPortfolioModal">
                                <i class="bi bi-wallet2"></i> Portfolio
                            </button>
                        </div>
                    </div>
                    
                    <!-- Variations -->
                    <div class="row g-3 mb-4">
                        <div class="col-4">
                            <div class="p-3 border rounded">
                                <small class="text-muted">Variation 1h</small>
                                <h5 class="mb-0 {% if change_1h|floatformat:2|slice:':1' == '-' %}price-down{% else %}price-up{% endif %}">
                                    {{ change_1h }}%
                                </h5>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-3 border rounded">
                                <small class="text-muted">Variation 24h</small>
                                <h5 class="mb-0 {% if change_24h|floatformat:2|slice:':1' == '-' %}price-down{% else %}price-up{% endif %}">
                                    {{ change_24h }}%
                                </h5>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-3 border rounded">
                                <small class="text-muted">Variation 7j</small>
                                <h5 class="mb-0 {% if change_7d|floatformat:2|slice:':1' == '-' %}price-down{% else %}price-up{% endif %}">
                                    {{ change_7d }}%
                                </h5>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sélecteur d'intervalle pour le graphique -->
                    <div class="mb-3 d-flex align-items-center gap-2 flex-wrap">
                        <label class="mb-0 fw-bold text-white">
                            <i class="bi bi-clock-history"></i> Intervalle:
                        </label>
                        <div class="btn-group" role="group" aria-label="Sélection d'intervalle">
                            <input type="radio" class="btn-check" name="chartInterval" id="interval1m" value="1" checked>
                            <label class="btn btn-outline-primary btn-sm" for="interval1m">1m</label>
                            
                            <input type="radio" class="btn-check" name="chartInterval" id="interval5m" value="5">
                            <label class="btn btn-outline-primary btn-sm" for="interval5m">5m</label>
                            
                            <input type="radio" class="btn-check" name="chartInterval" id="interval15m" value="15">
                            <label class="btn btn-outline-primary btn-sm" for="interval15m">15m</label>
                            
                            <input type="radio" class="btn-check" name="chartInterval" id="interval30m" value="30">
                            <label class="btn btn-outline-primary btn-sm" for="interval30m">30m</label>
                            
                            <input type="radio" class="btn-check" name="chartInterval" id="interval1h" value="1H">
                            <label class="btn btn-outline-primary btn-sm" for="interval1h">1h</label>
                            
                            <input type="radio" class="btn-check" name="chartInterval" id="interval4h" value="4H">
                            <label class="btn btn-outline-primary btn-sm" for="interval4h">4h</label>
                            
                            <input type="radio" class="btn-check" name="chartInterval" id="interval1D" value="D">
                            <label class="btn btn-outline-primary btn-sm" for="interval1D">1D</label>
                            
                            <input type="radio" class="btn-check" name="chartInterval" id="interval1W" value="W">
                            <label class="btn btn-outline-primary btn-sm" for="interval1W">1W</label>
                        </div>
                    </div>
                    
                    <!-- TradingView Widget -->
                    <div class="tradingview-widget-container" style="height: 600px; width: 100%;">
                        <div id="tradingview_chart" style="height: 100%; width: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Statistiques et Trading -->
        <div class="col-md-4">
            <!-- Statistiques 24h -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Statistiques 24h</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <small class="text-muted">Volume</small>
                        <h6>{{ volume }}</h6>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Volume en quote</small>
                        <h6>{{ quote_volume }}</h6>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Plus haut (24h)</small>
                        <h6 id="high24h">${{ high_24h_formatted }}</h6>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Plus bas (24h)</small>
                        <h6 id="low24h">${{ low_24h_formatted }}</h6>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <small class="text-muted">ATH (52 semaines)</small>
                        <h6 class="price-up" id="ath52w">${{ ath_formatted }}</h6>
                    </div>
                    <div class="mb-0">
                        <small class="text-muted">ATL (52 semaines)</small>
                        <h6 class="price-down" id="atl52w">${{ atl_formatted }}</h6>
                    </div>
                </div>
            </div>
            
            <!-- Paper Trading -->
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, #6366f1, #8b5cf6) !important; border: none;">
                    <h5 class="mb-0" style="color: #ffffff;">
                        <i class="bi bi-cash-coin"></i> Paper Trading
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Sélecteur de compte horizontal -->
                    <div class="mb-3">
                        <label class="form-label fw-bold mb-2">
                            <i class="bi bi-wallet2"></i> Type de compte
                        </label>
                        <div class="btn-group w-100" role="group" aria-label="Type de compte">
                            <input type="radio" class="btn-check" name="accountType" id="accountTypeFinance" value="finance" onchange="updateAccountBalance()">
                            <label class="btn btn-outline-primary" for="accountTypeFinance">
                                <i class="bi bi-bank"></i> Finance
                            </label>
                            
                            <input type="radio" class="btn-check" name="accountType" id="accountTypeTrading" value="trading" checked onchange="updateAccountBalance()">
                            <label class="btn btn-outline-primary" for="accountTypeTrading">
                                <i class="bi bi-coin"></i> Trading Spot
                            </label>
                            
                            <input type="radio" class="btn-check" name="accountType" id="accountTypeMargin" value="margin" onchange="updateAccountBalance()">
                            <label class="btn btn-outline-primary" for="accountTypeMargin">
                                <i class="bi bi-credit-card-2-front"></i> Marge
                            </label>
                        </div>
                    </div>
                    
                    <!-- Sélecteur de levier (uniquement pour Marge) -->
                    <div class="mb-3" id="leverageSection" style="display: none;">
                        <label class="form-label fw-bold">
                            <i class="bi bi-graph-up-arrow"></i> Effet de levier
                        </label>
                        <select class="form-select" id="leverage">
                            <option value="1">x1 (Pas de levier)</option>
                            <option value="2">x2</option>
                            <option value="3">x3</option>
                            <option value="4">x4</option>
                            <option value="5" selected>x5 (Maximum)</option>
                        </select>
                        <small class="text-muted d-block mt-1">
                            <i class="bi bi-info-circle"></i> Levier maximum: x5. Risque de liquidation augmenté.
                        </small>
                    </div>
                    
                    <!-- Solde actuel -->
                    <div class="mb-3 p-3" style="background: #1a1a1a; border-radius: 8px;">
                        <small class="text-muted d-block">Solde disponible</small>
                        <h4 class="mb-0 text-success" id="tradingBalance">${{ trading_balance|floatformat:2 }}</h4>
                    </div>
                    
                    <!-- Position actuelle -->
                    <div class="mb-3" id="positionSection" style="display: none;">
                        <div class="p-3" style="background: #1a1a1a; border-radius: 8px;">
                            <small class="text-muted d-block">Position actuelle</small>
                            <h5 class="mb-1" id="heldQuantity">0 {{ symbol }}</h5>
                            <small class="text-muted">Prix moyen: $0.00</small>
                        </div>
                    </div>
                    
                    <!-- Formulaire d'achat -->
                    <div class="mb-3">
                        <label class="form-label fw-bold text-success">
                            <i class="bi bi-arrow-down-circle"></i> Acheter
                        </label>
                        <div class="input-group mb-2">
                            <input type="number" class="form-control" id="buyQuantity" placeholder="Quantité" step="0.00000001" min="0" oninput="updateBuyCost()">
                        </div>
                        <div class="d-grid">
                            <button class="btn btn-success" onclick="buyToken()">
                                <i class="bi bi-cart-plus"></i> Acheter à $<span id="currentPriceBuy">{{ current_price.price }}</span>
                            </button>
                        </div>
                        <small class="text-muted" id="buyCost">Coût: $0.00</small>
                        <small class="text-warning d-block mt-1" id="marginInfo" style="display: none;">
                            <i class="bi bi-exclamation-triangle"></i> Marge requise: $<span id="requiredMargin">0.00</span>
                        </small>
                    </div>
                    
                    <hr>
                    
                    <!-- Formulaire de vente -->
                    <div class="mb-0">
                        <label class="form-label fw-bold text-danger">
                            <i class="bi bi-arrow-up-circle"></i> Vendre
                        </label>
                        <div class="input-group mb-2">
                            <input type="number" class="form-control" id="sellQuantity" placeholder="Quantité" step="0.00000001" min="0" oninput="updateSellRevenue()">
                        </div>
                        <div class="d-grid">
                            <button class="btn btn-danger" onclick="sellToken()">
                                <i class="bi bi-cart-dash"></i> Vendre à $<span id="currentPriceSell">{{ current_price.price }}</span>
                            </button>
                        </div>
                        <small class="text-muted" id="sellRevenue">Revenu: $0.00</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Carnet d'ordres et transactions récentes -->
    <div class="row mb-4">
        <div class="col-md-6 mb-4 mb-md-0">
            <div class="card order-book-card">
                <div class="card-header">
                    <h5 class="mb-0" style="font-size: 1rem; font-weight: 600;">
                        <i class="bi bi-book" style="color: #6366f1;"></i> 
                        <span style="color: #e0e0e0;">Carnet d'ordres</span>
                    </h5>
                </div>
                <div class="card-body p-0">
                    <!-- Ordres d'achat (Bids) -->
                    <div class="order-section-header">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-arrow-up-circle-fill price-up me-2" style="font-size: 1.1rem;"></i>
                            <h6 class="mb-0 price-up" style="font-weight: 600; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px;">Ordres d'achat</h6>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table order-book-table mb-0">
                            <thead>
                                <tr>
                                    <th><i class="bi bi-currency-dollar"></i> Prix</th>
                                    <th class="text-end"><i class="bi bi-box"></i> Quantité</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for bid in order_book.bids|slice:":8" %}
                                <tr>
                                    <td class="price-up fw-bold">{{ bid.0 }}</td>
                                    <td class="text-end">{{ bid.1 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Séparateur -->
                    <div class="order-divider"></div>
                    
                    <!-- Ordres de vente (Asks) -->
                    <div class="order-section-header">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-arrow-down-circle-fill price-down me-2" style="font-size: 1.1rem;"></i>
                            <h6 class="mb-0 price-down" style="font-weight: 600; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px;">Ordres de vente</h6>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table order-book-table mb-0">
                            <thead>
                                <tr>
                                    <th><i class="bi bi-currency-dollar"></i> Prix</th>
                                    <th class="text-end"><i class="bi bi-box"></i> Quantité</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ask in order_book.asks|slice:":8" %}
                                <tr>
                                    <td class="price-down fw-bold">{{ ask.0 }}</td>
                                    <td class="text-end">{{ ask.1 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card order-book-card">
                <div class="card-header">
                    <h5 class="mb-0" style="font-size: 1rem; font-weight: 600;">
                        <i class="bi bi-clock-history" style="color: #10b981;"></i> 
                        <span style="color: #e0e0e0;">Transactions récentes</span>
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table order-book-table mb-0">
                            <thead>
                                <tr>
                                    <th><i class="bi bi-currency-dollar"></i> Prix</th>
                                    <th class="text-end"><i class="bi bi-box"></i> Quantité</th>
                                    <th class="text-end"><i class="bi bi-clock"></i> Heure</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for trade in recent_trades %}
                                <tr>
                                    <td class="transactions-price">{{ trade.price }}</td>
                                    <td class="text-end">{{ trade.qty }}</td>
                                    <td class="text-end">
                                        <span class="badge" style="background: rgba(99, 102, 241, 0.2); color: #8b92ff; font-size: 0.8rem;">
                                            {{ trade.time|date:"H:i:s" }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Section Position Margin (affichée uniquement si une position margin est ouverte) -->
    <div class="row mb-4" id="marginPositionSection" style="display: none;">
        <div class="col-12">
            <div class="card order-book-card">
                <div class="card-header">
                    <h5 class="mb-0" style="font-size: 1rem; font-weight: 600;">
                        <i class="bi bi-graph-up-arrow" style="color: #6366f1;"></i> 
                        <span style="color: #e0e0e0;">Position Margin Active - <span id="marginPositionSymbol"></span></span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <!-- Situation de la position -->
                        <div class="col-md-6 col-lg-3">
                            <div class="p-3" style="background: #1a1a1a; border-radius: 8px;">
                                <small class="text-muted d-block mb-2">Quantité</small>
                                <h5 class="mb-0 text-white" id="marginPositionQuantity">0</h5>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <div class="p-3" style="background: #1a1a1a; border-radius: 8px;">
                                <small class="text-muted d-block mb-2">Prix d'entrée moyen</small>
                                <h5 class="mb-0 text-white" id="marginPositionEntryPrice">$0.00</h5>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <div class="p-3" style="background: #1a1a1a; border-radius: 8px;">
                                <small class="text-muted d-block mb-2">Prix actuel</small>
                                <h5 class="mb-0 text-white" id="marginPositionCurrentPrice">$0.00</h5>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <div class="p-3" style="background: #1a1a1a; border-radius: 8px;">
                                <small class="text-muted d-block mb-2">Levier</small>
                                <h5 class="mb-0 text-warning" id="marginPositionLeverage">x1</h5>
                            </div>
                        </div>
                        
                        <!-- P&L -->
                        <div class="col-md-6 col-lg-3">
                            <div class="p-3" style="background: #1a1a1a; border-radius: 8px;">
                                <small class="text-muted d-block mb-2">P&L Non réalisé</small>
                                <h5 class="mb-0" id="marginPositionPnL" style="color: #10b981;">$0.00</h5>
                                <small class="text-muted" id="marginPositionPnLPercent">0.00%</small>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <div class="p-3" style="background: #1a1a1a; border-radius: 8px;">
                                <small class="text-muted d-block mb-2">Valeur actuelle</small>
                                <h5 class="mb-0 text-white" id="marginPositionCurrentValue">$0.00</h5>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <div class="p-3" style="background: #1a1a1a; border-radius: 8px;">
                                <small class="text-muted d-block mb-2">Prix de liquidation</small>
                                <h5 class="mb-0 text-danger" id="marginPositionLiquidationPrice">$0.00</h5>
                                <small class="text-muted" id="marginPositionDistanceToLiquidation">0.00%</small>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <div class="p-3" style="background: #1a1a1a; border-radius: 8px;" id="marginRiskCard">
                                <small class="text-muted d-block mb-2">Margin Risk</small>
                                <h5 class="mb-0" id="marginRiskLevel">Low</h5>
                                <small class="text-muted" id="marginRiskPercent">0.00%</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Paires similaires -->
    {% if similar_pairs %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-link-45deg"></i> Paires similaires</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        {% for pair in similar_pairs %}
                        <div class="col-md-4 col-lg-2">
                            <a href="{% url 'pairs:detail' pair.symbol %}" class="text-decoration-none">
                                <div class="card text-center h-100">
                                    <div class="card-body">
                                        <h6 class="mb-2">{{ pair.symbol }}</h6>
                                        <small class="d-block mb-1">${{ pair.price }}</small>
                                        <small class="{% if pair.change|floatformat:2|slice:':1' == '-' %}price-down{% else %}price-up{% endif %}">
                                            {{ pair.change }}%
                                        </small>
                                    </div>
                                </div>
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal pour ajouter au portfolio -->
<div class="modal fade" id="addPortfolioModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="background: var(--card-bg);">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-wallet2"></i> Ajouter au Portfolio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="portfolioForm">
                    <div class="mb-3">
                        <label class="form-label">Symbole</label>
                        <input type="text" class="form-control" value="{{ symbol }}" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Quantité</label>
                        <input type="number" class="form-control" id="quantity" step="0.00000001" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Prix d'achat</label>
                        <input type="number" class="form-control" id="purchasePrice" step="0.00000001" 
                               value="{{ current_price.price }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes (optionnel)</label>
                        <textarea class="form-control" id="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-success" onclick="addToPortfolio()">
                    <i class="bi bi-check-circle"></i> Ajouter
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- TradingView Widget Script -->
<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<script type="text/javascript">
// Variables globales pour le widget TradingView
var tradingViewWidget = null;
var tvSymbol = null;

// Fonction pour déterminer le format du symbole pour TradingView
function getTradingViewSymbol(symbol) {
    // Liste des symboles populaires qui fonctionnent sur TradingView
    var popularSymbols = ['BTCUSDT', 'ETHUSDT', 'BNBUSDT', 'XRPUSDT', 'ADAUSDT', 
                         'DOGEUSDT', 'SOLUSDT', 'MATICUSDT', 'DOTUSDT', 'LTCUSDT',
                         'AVAXUSDT', 'LINKUSDT', 'ATOMUSDT', 'ETCUSDT'];
    
    // Si c'est un symbole populaire, on utilise BINANCE:
    if (popularSymbols.includes(symbol)) {
        return "BINANCE:" + symbol;
    } else {
        // Pour les autres, on essaie différents formats
        if (symbol.endsWith('USDT')) {
            return "BINANCE:" + symbol;
        } else if (symbol.endsWith('BUSD')) {
            // BUSD n'est plus supporté, essayer USDT à la place
            var baseAsset = symbol.replace('BUSD', '');
            return "BINANCE:" + baseAsset + "USDT";
        } else if (symbol.endsWith('BTC')) {
            return "BINANCE:" + symbol;
        } else {
            // Par défaut, essayer avec BINANCE
            return "BINANCE:" + symbol;
        }
    }
}

// Fonction pour créer/détruire le widget TradingView avec un intervalle donné
function initTradingViewWidget(interval) {
    var symbol = "{{ symbol }}";
    tvSymbol = getTradingViewSymbol(symbol);
    
    // Détruire le widget existant s'il existe
    if (tradingViewWidget) {
        try {
            tradingViewWidget.remove();
        } catch (e) {
            console.warn("[WARNING] Erreur lors de la suppression du widget:", e);
        }
        tradingViewWidget = null;
    }
    
    // Vider le conteneur
    var container = document.getElementById('tradingview_chart');
    if (container) {
        container.innerHTML = '';
    }
    
    try {
        tradingViewWidget = new TradingView.widget({
            "width": "100%",
            "height": 600,
            "symbol": tvSymbol,
            "interval": interval,
            "timezone": "Europe/Paris",
            "theme": "dark",
            "style": "1",  // 1 = Bougies japonaises (par défaut)
            "locale": "fr",
            "toolbar_bg": "#1e293b",
            "enable_publishing": false,
            "withdateranges": true,
            "hide_side_toolbar": false,
            "allow_symbol_change": true,
            "save_image": true,
            "container_id": "tradingview_chart",
            
            // Paramètres pour améliorer la compatibilité
            "autosize": true,
            "hide_top_toolbar": false,
            "hide_legend": false,
            "show_popup_button": true,
            
            // Études (Indicateurs) par défaut
            "studies": [],
            
            // Paramètres avancés
            "details": true,
            "hotlist": true,
            "calendar": false,
            "popup_width": "1000",
            "popup_height": "650",
            
            // Callback pour gérer les erreurs
            "disabled_features": [],
            "enabled_features": ["study_templates"],
            
            // Fonctionnalités activées
            "support_host": "https://www.tradingview.com"
        });
        
        console.log("[CHART] Graphique TradingView chargé pour:", tvSymbol, "avec intervalle:", interval);
    } catch (error) {
        console.error("[ERREUR] Erreur lors du chargement du graphique TradingView:", error);
        if (container) {
            container.innerHTML = 
                '<div class="alert alert-warning m-3">' +
                '<i class="bi bi-exclamation-triangle"></i> ' +
                '<strong>Graphique temporairement indisponible</strong><br>' +
                'Le symbole <code>' + symbol + '</code> n\'existe pas sur TradingView.<br><br>' +
                '<small><strong>Suggestion:</strong> TradingView ne supporte que les paires principales de Binance. ' +
                'Les données de prix actuelles proviennent directement de Binance et sont affichées ci-dessus.</small>' +
                '</div>';
        }
    }
}

// Initialiser le widget TradingView avec l'intervalle par défaut (1m)
// Attendre que le DOM soit chargé
document.addEventListener('DOMContentLoaded', function() {
    // Intervalle par défaut: 1 minute (1m)
    var defaultInterval = "1";
    initTradingViewWidget(defaultInterval);
    
    // Écouter les changements d'intervalle
    document.querySelectorAll('input[name="chartInterval"]').forEach(function(radio) {
        radio.addEventListener('change', function() {
            if (this.checked) {
                var interval = this.value;
                console.log("[CHART] Changement d'intervalle vers:", interval);
                initTradingViewWidget(interval);
            }
        });
    });
});

function addToWatchlist(symbol) {
    fetch('/watchlist/add/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ symbol: symbol })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('[OK] ' + symbol + ' ajoute a votre watchlist !');
        } else {
            alert('Erreur: ' + data.error);
        }
    });
}

function addToPortfolio() {
    const quantity = document.getElementById('quantity').value;
    const purchasePrice = document.getElementById('purchasePrice').value;
    const notes = document.getElementById('notes').value;
    
    fetch('/watchlist/portfolio/add/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            symbol: '{{ symbol }}',
            quantity: quantity,
            purchase_price: purchasePrice,
            notes: notes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('[OK] Ajoute au portfolio !');
            bootstrap.Modal.getInstance(document.getElementById('addPortfolioModal')).hide();
            document.getElementById('portfolioForm').reset();
        } else {
            alert('Erreur: ' + data.error);
        }
    });
}

// ========================================
// MISE À JOUR EN TEMPS RÉEL
// ========================================

let updateInterval;
const SYMBOL = '{{ symbol }}';

// Fonction pour mettre à jour le carnet d'ordres
function updateOrderBook(data) {
    if (!data.order_book) return;
    
    // Mettre à jour les ordres d'achat (bids)
    const bidsBody = document.querySelector('.order-book-table tbody');
    if (bidsBody && data.order_book.bids) {
        let bidsHTML = '';
        data.order_book.bids.forEach(bid => {
            bidsHTML += `
                <tr>
                    <td class="price-up fw-bold">${bid[0]}</td>
                    <td class="text-end">${bid[1]}</td>
                </tr>
            `;
        });
        const bidsTable = document.querySelectorAll('.order-book-table tbody')[0];
        if (bidsTable) bidsTable.innerHTML = bidsHTML;
    }
    
    // Mettre à jour les ordres de vente (asks)
    if (data.order_book.asks) {
        let asksHTML = '';
        data.order_book.asks.forEach(ask => {
            asksHTML += `
                <tr>
                    <td class="price-down fw-bold">${ask[0]}</td>
                    <td class="text-end">${ask[1]}</td>
                </tr>
            `;
        });
        const asksTable = document.querySelectorAll('.order-book-table tbody')[1];
        if (asksTable) asksTable.innerHTML = asksHTML;
    }
}

// Fonction pour mettre à jour les transactions récentes
function updateRecentTrades(data) {
    if (!data.recent_trades) return;
    
    const tradesTable = document.querySelectorAll('.order-book-table tbody')[2];
    if (!tradesTable) return;
    
    let tradesHTML = '';
    data.recent_trades.forEach(trade => {
        tradesHTML += `
            <tr>
                <td class="transactions-price">${trade.price}</td>
                <td class="text-end">${trade.qty}</td>
                <td class="text-end">
                    <span class="badge" style="background: rgba(99, 102, 241, 0.2); color: #8b92ff; font-size: 0.8rem;">
                        ${trade.time}
                    </span>
                </td>
            </tr>
        `;
    });
    tradesTable.innerHTML = tradesHTML;
}

// Fonction pour mettre à jour le prix et les statistiques
function updateTicker(data) {
    if (!data.ticker) return;
    
    // Formater un prix pour l'affichage
    function formatPrice(price) {
        const p = parseFloat(price);
        if (isNaN(p) || p === 0) return '0.00';
        if (p >= 1000) return p.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        if (p >= 1) return p.toFixed(2);
        return p.toFixed(8).replace(/\.?0+$/, '');
    }
    
    // Mettre à jour le prix principal
    const priceElement = document.querySelector('h3.mb-0');
    if (priceElement && data.ticker.lastPrice) {
        priceElement.textContent = '$' + formatPrice(data.ticker.lastPrice);
    }
    
    // Mettre à jour les statistiques 24h
    if (data.ticker.highPrice) {
        const high24hElement = document.getElementById('high24h');
        if (high24hElement) {
            high24hElement.textContent = '$' + formatPrice(data.ticker.highPrice);
        }
    }
    
    if (data.ticker.lowPrice) {
        const low24hElement = document.getElementById('low24h');
        if (low24hElement) {
            low24hElement.textContent = '$' + formatPrice(data.ticker.lowPrice);
        }
    }
    
            // Mettre à jour les prix de trading
            if (data.ticker.lastPrice) {
                const buyPriceElement = document.getElementById('currentPriceBuy');
                const sellPriceElement = document.getElementById('currentPriceSell');
                const priceValue = parseFloat(data.ticker.lastPrice);
                const formattedPrice = formatPrice(data.ticker.lastPrice);
                
                // Stocker le prix brut dans un attribut data pour les calculs
                if (buyPriceElement) {
                    buyPriceElement.textContent = formattedPrice;
                    buyPriceElement.setAttribute('data-price', priceValue);
                }
                if (sellPriceElement) {
                    sellPriceElement.textContent = formattedPrice;
                    sellPriceElement.setAttribute('data-price', priceValue);
                }
            }
}

// Fonction principale pour récupérer les données
async function fetchLiveData() {
    try {
        const response = await fetch(`/pairs/api/${SYMBOL}/`);
        if (!response.ok) throw new Error('Network error');
        
        const data = await response.json();
        
        // Mettre à jour chaque section
        updateOrderBook(data);
        updateRecentTrades(data);
        updateTicker(data);
        
        console.log('[DATA] Donnees mises a jour:', new Date().toLocaleTimeString());
    } catch (error) {
        console.error('[ERREUR] Erreur lors de la mise a jour:', error);
    }
}

// Démarrer les mises à jour automatiques toutes les 3 secondes
function startLiveUpdates() {
    // Première mise à jour immédiate
    fetchLiveData();
    
    // Puis toutes les 3 secondes
    updateInterval = setInterval(fetchLiveData, 3000);
    
    console.log('[OK] Mises a jour en temps reel activees (toutes les 3s)');
}

// Arrêter les mises à jour (utile si on quitte la page)
function stopLiveUpdates() {
    if (updateInterval) {
        clearInterval(updateInterval);
        console.log('[STOP] Mises a jour en temps reel arretees');
    }
}

// Vérifier automatiquement s'il y a une position margin pour ce symbole au chargement
async function checkMarginPositionOnLoad() {
    if (!SYMBOL) return;
    
    try {
        const response = await fetch(`/watchlist/trading/margin-position/${SYMBOL}/`);
        if (response.ok) {
            const data = await response.json();
            if (data.success && data.has_position) {
                // Si une position margin existe, sélectionner automatiquement le compte margin
                const marginRadio = document.getElementById('accountTypeMargin');
                if (marginRadio) {
                    marginRadio.checked = true;
                    // Attendre un peu pour que le DOM soit prêt
                    setTimeout(() => {
                        updateAccountBalance();
                    }, 100);
                }
            }
        }
    } catch (error) {
        console.error('Erreur lors de la vérification de la position margin:', error);
    }
}

// Fonction pour vérifier et afficher la position margin indépendamment du compte sélectionné
async function checkAndDisplayMarginPosition() {
    if (!SYMBOL) return;
    
    try {
        const response = await fetch(`/watchlist/trading/margin-position/${SYMBOL}/`);
        if (response.ok) {
            const data = await response.json();
            if (data.success && data.has_position) {
                // Afficher la section même si le compte sélectionné n'est pas margin
                document.getElementById('marginPositionSection').style.display = 'block';
                
                // Mettre à jour les informations
                document.getElementById('marginPositionSymbol').textContent = data.symbol;
                document.getElementById('marginPositionQuantity').textContent = data.quantity.toFixed(8);
                document.getElementById('marginPositionEntryPrice').textContent = `$${data.avg_entry_price.toFixed(8)}`;
                document.getElementById('marginPositionCurrentPrice').textContent = `$${data.current_price.toFixed(8)}`;
                document.getElementById('marginPositionLeverage').textContent = `x${data.leverage.toFixed(2)}`;
                document.getElementById('marginPositionCurrentValue').textContent = `$${data.current_value.toFixed(2)}`;
                
                // P&L avec couleur
                const pnlElement = document.getElementById('marginPositionPnL');
                const pnlPercentElement = document.getElementById('marginPositionPnLPercent');
                if (data.unrealized_pnl >= 0) {
                    pnlElement.textContent = `+$${data.unrealized_pnl.toFixed(2)}`;
                    pnlElement.style.color = '#10b981';
                    pnlPercentElement.textContent = `+${data.unrealized_pnl_percent.toFixed(2)}%`;
                    pnlPercentElement.style.color = '#10b981';
                } else {
                    pnlElement.textContent = `$${data.unrealized_pnl.toFixed(2)}`;
                    pnlElement.style.color = '#ef4444';
                    pnlPercentElement.textContent = `${data.unrealized_pnl_percent.toFixed(2)}%`;
                    pnlPercentElement.style.color = '#ef4444';
                }
                
                // Prix de liquidation
                if (data.liquidation_price) {
                    document.getElementById('marginPositionLiquidationPrice').textContent = `$${data.liquidation_price.toFixed(8)}`;
                    if (data.distance_to_liquidation !== null && data.distance_to_liquidation !== undefined) {
                        const distanceElement = document.getElementById('marginPositionDistanceToLiquidation');
                        distanceElement.textContent = `${data.distance_to_liquidation.toFixed(2)}%`;
                        if (data.distance_to_liquidation < 10) {
                            distanceElement.style.color = '#ef4444';
                        } else if (data.distance_to_liquidation < 20) {
                            distanceElement.style.color = '#f59e0b';
                        } else {
                            distanceElement.style.color = '#10b981';
                        }
                    }
                } else {
                    document.getElementById('marginPositionLiquidationPrice').textContent = 'N/A';
                    document.getElementById('marginPositionDistanceToLiquidation').textContent = '';
                }
                
                // Margin Risk
                const riskCard = document.getElementById('marginRiskCard');
                const riskLevelElement = document.getElementById('marginRiskLevel');
                const riskPercentElement = document.getElementById('marginRiskPercent');
                
                riskPercentElement.textContent = `${data.risk_percent.toFixed(2)}%`;
                
                if (data.risk_level === 'high') {
                    riskLevelElement.textContent = 'HIGH';
                    riskLevelElement.style.color = '#ef4444';
                    riskPercentElement.style.color = '#ef4444';
                    riskCard.style.background = '#2a1a1a';
                    riskCard.style.border = '1px solid #ef4444';
                } else if (data.risk_level === 'medium') {
                    riskLevelElement.textContent = 'MEDIUM';
                    riskLevelElement.style.color = '#f59e0b';
                    riskPercentElement.style.color = '#f59e0b';
                    riskCard.style.background = '#2a251a';
                    riskCard.style.border = '1px solid #f59e0b';
                } else {
                    riskLevelElement.textContent = 'LOW';
                    riskLevelElement.style.color = '#10b981';
                    riskPercentElement.style.color = '#10b981';
                    riskCard.style.background = '#1a2a1a';
                    riskCard.style.border = '1px solid #10b981';
                }
            } else {
                // Masquer la section si pas de position
                document.getElementById('marginPositionSection').style.display = 'none';
            }
        }
    } catch (error) {
        console.error('Erreur lors de la vérification de la position margin:', error);
        document.getElementById('marginPositionSection').style.display = 'none';
    }
}

// Démarrer au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    // Initialiser les attributs data-price avec les prix du template
    const buyPriceElement = document.getElementById('currentPriceBuy');
    const sellPriceElement = document.getElementById('currentPriceSell');
    if (buyPriceElement && !buyPriceElement.getAttribute('data-price')) {
        const initialPrice = parseFloat(buyPriceElement.textContent.replace(/,/g, '') || 0);
        buyPriceElement.setAttribute('data-price', initialPrice);
    }
    if (sellPriceElement && !sellPriceElement.getAttribute('data-price')) {
        const initialPrice = parseFloat(sellPriceElement.textContent.replace(/,/g, '') || 0);
        sellPriceElement.setAttribute('data-price', initialPrice);
    }
    
    startLiveUpdates();
    
    // Vérifier et afficher la position margin si elle existe (indépendamment du compte sélectionné)
    checkAndDisplayMarginPosition();
    
    // Vérifier s'il y a une position margin pour sélectionner automatiquement le compte margin
    checkMarginPositionOnLoad();
    
    // Initialiser le solde du compte par défaut (trading)
    updateAccountBalance();
    
    // Écouter les changements du sélecteur de compte (boutons radio)
    document.querySelectorAll('input[name="accountType"]').forEach(radio => {
        radio.addEventListener('change', updateAccountBalance);
    });
    
    // Écouter les changements du levier pour mettre à jour le coût
    document.getElementById('leverage')?.addEventListener('change', updateBuyCost);
    
    // Mettre à jour la position margin toutes les 3 secondes (peu importe le compte sélectionné)
    setInterval(function() {
        checkAndDisplayMarginPosition();
    }, 3000);
});

// Arrêter quand on quitte la page
window.addEventListener('beforeunload', function() {
    stopLiveUpdates();
});

// ========================================
// PAPER TRADING FUNCTIONS
// ========================================

// Mettre à jour le solde selon le compte sélectionné
async function updateAccountBalance() {
    const accountType = document.querySelector('input[name="accountType"]:checked')?.value || 'trading';
    const leverageSection = document.getElementById('leverageSection');
    
    // Afficher/masquer le sélecteur de levier
    if (accountType === 'margin') {
        leverageSection.style.display = 'block';
        // Récupérer et afficher les informations de position margin
        updateMarginPosition();
    } else {
        leverageSection.style.display = 'none';
        // Masquer la section position margin si on n'est pas en mode margin
        document.getElementById('marginPositionSection').style.display = 'none';
    }
    
    // Récupérer le solde du compte (faire un fetch vers l'API)
    try {
        const response = await fetch(`/watchlist/portfolio/${accountType}/balance/`);
        if (response.ok) {
            const data = await response.json();
            document.getElementById('tradingBalance').textContent = `$${data.balance.toFixed(2)}`;
            
            // Mettre à jour les positions si disponibles
            if (data.positions && data.positions.length > 0) {
                const posSection = document.getElementById('positionSection');
                const totalQty = data.positions.reduce((sum, p) => sum + parseFloat(p.quantity), 0);
                const avgPrice = data.positions.reduce((sum, p) => sum + parseFloat(p.purchase_price) * parseFloat(p.quantity), 0) / totalQty;
                document.getElementById('heldQuantity').textContent = `${totalQty.toFixed(8)} {{ symbol }}`;
                posSection.style.display = 'block';
            } else {
                document.getElementById('positionSection').style.display = 'none';
            }
        }
    } catch (error) {
        console.error('Erreur lors de la récupération du solde:', error);
    }
    
    updateBuyCost();
}

// Mettre à jour les informations de position margin en temps réel
async function updateMarginPosition() {
    const accountType = document.querySelector('input[name="accountType"]:checked')?.value || 'trading';
    
    // Vérifier si on est en mode margin et qu'on a un symbole
    if (accountType !== 'margin' || !SYMBOL) {
        document.getElementById('marginPositionSection').style.display = 'none';
        return;
    }
    
    try {
        const response = await fetch(`/watchlist/trading/margin-position/${SYMBOL}/`);
        if (!response.ok) {
            throw new Error('Erreur lors de la récupération des informations de position');
        }
        
        const data = await response.json();
        
        if (data.success && data.has_position) {
            // Afficher la section
            document.getElementById('marginPositionSection').style.display = 'block';
            
            // Mettre à jour les informations
            document.getElementById('marginPositionSymbol').textContent = data.symbol;
            document.getElementById('marginPositionQuantity').textContent = data.quantity.toFixed(8);
            document.getElementById('marginPositionEntryPrice').textContent = `$${data.avg_entry_price.toFixed(8)}`;
            document.getElementById('marginPositionCurrentPrice').textContent = `$${data.current_price.toFixed(8)}`;
            document.getElementById('marginPositionLeverage').textContent = `x${data.leverage.toFixed(2)}`;
            document.getElementById('marginPositionCurrentValue').textContent = `$${data.current_value.toFixed(2)}`;
            
            // P&L avec couleur
            const pnlElement = document.getElementById('marginPositionPnL');
            const pnlPercentElement = document.getElementById('marginPositionPnLPercent');
            if (data.unrealized_pnl >= 0) {
                pnlElement.textContent = `+$${data.unrealized_pnl.toFixed(2)}`;
                pnlElement.style.color = '#10b981';
                pnlPercentElement.textContent = `+${data.unrealized_pnl_percent.toFixed(2)}%`;
                pnlPercentElement.style.color = '#10b981';
            } else {
                pnlElement.textContent = `$${data.unrealized_pnl.toFixed(2)}`;
                pnlElement.style.color = '#ef4444';
                pnlPercentElement.textContent = `${data.unrealized_pnl_percent.toFixed(2)}%`;
                pnlPercentElement.style.color = '#ef4444';
            }
            
            // Prix de liquidation
            if (data.liquidation_price) {
                document.getElementById('marginPositionLiquidationPrice').textContent = `$${data.liquidation_price.toFixed(8)}`;
                if (data.distance_to_liquidation !== null && data.distance_to_liquidation !== undefined) {
                    const distanceElement = document.getElementById('marginPositionDistanceToLiquidation');
                    distanceElement.textContent = `${data.distance_to_liquidation.toFixed(2)}%`;
                    if (data.distance_to_liquidation < 10) {
                        distanceElement.style.color = '#ef4444';
                    } else if (data.distance_to_liquidation < 20) {
                        distanceElement.style.color = '#f59e0b';
                    } else {
                        distanceElement.style.color = '#10b981';
                    }
                }
            } else {
                document.getElementById('marginPositionLiquidationPrice').textContent = 'N/A';
                document.getElementById('marginPositionDistanceToLiquidation').textContent = '';
            }
            
            // Margin Risk
            const riskCard = document.getElementById('marginRiskCard');
            const riskLevelElement = document.getElementById('marginRiskLevel');
            const riskPercentElement = document.getElementById('marginRiskPercent');
            
            riskPercentElement.textContent = `${data.risk_percent.toFixed(2)}%`;
            
            if (data.risk_level === 'high') {
                riskLevelElement.textContent = 'HIGH';
                riskLevelElement.style.color = '#ef4444';
                riskPercentElement.style.color = '#ef4444';
                riskCard.style.background = '#2a1a1a';
                riskCard.style.border = '1px solid #ef4444';
            } else if (data.risk_level === 'medium') {
                riskLevelElement.textContent = 'MEDIUM';
                riskLevelElement.style.color = '#f59e0b';
                riskPercentElement.style.color = '#f59e0b';
                riskCard.style.background = '#2a251a';
                riskCard.style.border = '1px solid #f59e0b';
            } else {
                riskLevelElement.textContent = 'LOW';
                riskLevelElement.style.color = '#10b981';
                riskPercentElement.style.color = '#10b981';
                riskCard.style.background = '#1a2a1a';
                riskCard.style.border = '1px solid #10b981';
            }
        } else {
            // Masquer la section si pas de position
            document.getElementById('marginPositionSection').style.display = 'none';
        }
    } catch (error) {
        console.error('Erreur lors de la mise à jour de la position margin:', error);
        // Masquer la section en cas d'erreur
        document.getElementById('marginPositionSection').style.display = 'none';
    }
}

// Calculer et afficher le coût d'achat en temps réel
function updateBuyCost() {
    const quantity = parseFloat(document.getElementById('buyQuantity').value) || 0;
    const priceElement = document.getElementById('currentPriceBuy');
    const price = parseFloat(priceElement?.getAttribute('data-price') || priceElement?.textContent.replace(/,/g, '') || 0);
    const accountType = document.querySelector('input[name="accountType"]:checked')?.value || 'trading';
    const leverage = parseInt(document.getElementById('leverage')?.value || 1);
    
    const totalValue = quantity * price;
    let cost = totalValue;
    let marginRequired = 0;
    
    // Pour margin avec levier, calculer la marge requise
    if (accountType === 'margin' && leverage > 1) {
        marginRequired = totalValue / leverage;
        cost = marginRequired;
        
        // Afficher l'info de marge
        document.getElementById('marginInfo').style.display = 'block';
        document.getElementById('requiredMargin').textContent = marginRequired.toFixed(2);
    } else {
        document.getElementById('marginInfo').style.display = 'none';
    }
    
    document.getElementById('buyCost').textContent = accountType === 'margin' && leverage > 1 
        ? `Marge requise: $${cost.toFixed(2)} (Valeur: $${totalValue.toFixed(2)})`
        : `Coût: $${cost.toFixed(2)}`;
}

// Calculer et afficher le revenu de vente en temps réel
function updateSellRevenue() {
    const quantity = parseFloat(document.getElementById('sellQuantity').value) || 0;
    const priceElement = document.getElementById('currentPriceSell');
    const price = parseFloat(priceElement?.getAttribute('data-price') || priceElement?.textContent.replace(/,/g, '') || 0);
    const revenue = quantity * price;
    const fee = revenue * 0.001; // 0.1% de frais
    const netRevenue = revenue - fee;
    document.getElementById('sellRevenue').textContent = `Revenu: $${revenue.toFixed(2)} (Net: $${netRevenue.toFixed(2)} après frais)`;
}

// Fonction pour acheter un token
async function buyToken() {
    const quantity = parseFloat(document.getElementById('buyQuantity').value);
    const priceElement = document.getElementById('currentPriceBuy');
    const price = parseFloat(priceElement?.getAttribute('data-price') || priceElement?.textContent.replace(/,/g, '') || 0);
    const accountType = document.querySelector('input[name="accountType"]:checked')?.value || 'trading';
    const leverage = parseInt(document.getElementById('leverage')?.value || 1);
    
    if (!quantity || quantity <= 0) {
        alert('[ATTENTION] Veuillez entrer une quantite valide');
        return;
    }
    
    const totalValue = quantity * price;
    const requiredMargin = accountType === 'margin' && leverage > 1 ? totalValue / leverage : totalValue;
    const currentBalance = parseFloat(document.getElementById('tradingBalance').textContent.replace(/[$,]/g, ''));
    
    if (requiredMargin > currentBalance) {
        alert(`[ERREUR] Fonds insuffisants!\nSolde: $${currentBalance.toFixed(2)}\nRequis: $${requiredMargin.toFixed(2)}`);
        return;
    }
    
    const confirmMsg = accountType === 'margin' && leverage > 1
        ? `Confirmer l'achat de ${quantity} {{ symbol }} à $${price}?\n\nValeur: $${totalValue.toFixed(2)}\nMarge requise: $${requiredMargin.toFixed(2)}\nLevier: x${leverage}`
        : `Confirmer l'achat de ${quantity} {{ symbol }} à $${price}?\n\nCoût total: $${totalValue.toFixed(2)}`;
    
    if (!confirm(confirmMsg)) {
        return;
    }
    
    try {
        const response = await fetch('/watchlist/trading/buy/', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                symbol: '{{ symbol }}',
                quantity: quantity,
                price: price,
                account_type: accountType,
                leverage: leverage
            })
        });
        
        // Vérifier si la réponse est JSON
        const contentType = response.headers.get("content-type");
        if (!contentType || !contentType.includes("application/json")) {
            const text = await response.text();
            throw new Error(`Réponse non-JSON reçue: ${text.substring(0, 200)}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            let msg = `[OK] ${data.message}\n\nNouveau solde: $${data.new_balance.toFixed(2)}`;
            
            // Ajouter les informations de liquidation si margin
            if (data.liquidation_price) {
                msg += `\n\n⚠️ INFORMATION MARGIN:\n`;
                msg += `Levier: x${data.leverage}\n`;
                msg += `Prix de liquidation estimé: $${data.liquidation_price.toFixed(2)}\n`;
                msg += `Surveillez ce prix pour éviter la liquidation!`;
            }
            
            alert(msg);
            // Mettre à jour le solde sans recharger toute la page
            document.getElementById('tradingBalance').textContent = `$${data.new_balance.toFixed(2)}`;
            // Mettre à jour la position margin si on est en mode margin
            if (accountType === 'margin') {
                setTimeout(() => updateMarginPosition(), 500);
            }
            // Recharger la page pour mettre à jour les positions
            setTimeout(() => location.reload(), 1000);
        } else {
            alert(`[ERREUR] Erreur: ${data.error}`);
        }
    } catch (error) {
        alert(`[ERREUR] Erreur lors de l'achat: ${error.message}`);
        console.error('Détails de l\'erreur:', error);
    }
}

// Fonction pour vendre un token
async function sellToken() {
    const quantity = parseFloat(document.getElementById('sellQuantity').value);
    const priceElement = document.getElementById('currentPriceSell');
    const price = parseFloat(priceElement?.getAttribute('data-price') || priceElement?.textContent.replace(/,/g, '') || 0);
    const accountType = document.querySelector('input[name="accountType"]:checked')?.value || 'trading';
    const held = parseFloat(document.getElementById('heldQuantity')?.textContent.split(' ')[0] || 0);
    
    if (!quantity || quantity <= 0) {
        alert('[ATTENTION] Veuillez entrer une quantite valide');
        return;
    }
    
    if (quantity > held) {
        alert(`[ERREUR] Quantite insuffisante!\nVous possedez: ${held} {{ symbol }}\nVous essayez de vendre: ${quantity} {{ symbol }}`);
        return;
    }
    
    const totalRevenue = quantity * price;
    const fee = totalRevenue * 0.001;
    const netRevenue = totalRevenue - fee;
    
    if (!confirm(`Confirmer la vente de ${quantity} {{ symbol }} à $${price}?\n\nRevenu brut: $${totalRevenue.toFixed(2)}\nFrais (0.1%): $${fee.toFixed(2)}\nRevenu net: $${netRevenue.toFixed(2)}`)) {
        return;
    }
    
    try {
        const response = await fetch('/watchlist/trading/sell/', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                symbol: '{{ symbol }}',
                quantity: quantity,
                price: price,
                account_type: accountType
            })
        });
        
        // Vérifier si la réponse est JSON
        const contentType = response.headers.get("content-type");
        if (!contentType || !contentType.includes("application/json")) {
            const text = await response.text();
            throw new Error(`Réponse non-JSON reçue: ${text.substring(0, 200)}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            let msg = `[OK] ${data.message}\n\nNouveau solde: $${data.new_balance.toFixed(2)}`;
            if (data.pnl !== null && data.pnl !== undefined) {
                msg += `\nP&L: $${data.pnl.toFixed(2)}`;
            }
            alert(msg);
            // Mettre à jour le solde sans recharger toute la page
            document.getElementById('tradingBalance').textContent = `$${data.new_balance.toFixed(2)}`;
            // Mettre à jour la position margin si on est en mode margin
            if (accountType === 'margin') {
                setTimeout(() => updateMarginPosition(), 500);
            }
            // Recharger la page pour mettre à jour les positions
            setTimeout(() => location.reload(), 1000);
        } else {
            alert(`[ERREUR] Erreur: ${data.error}`);
        }
    } catch (error) {
        alert(`[ERREUR] Erreur lors de la vente: ${error.message}`);
        console.error('Détails de l\'erreur:', error);
    }
}

// Fonction pour récupérer le cookie CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Mettre à jour les prix de trading en temps réel avec les données de l'API
function updateTradingPrices(data) {
    if (data.ticker && (data.ticker.price || data.ticker.lastPrice)) {
        const priceValue = parseFloat(data.ticker.price || data.ticker.lastPrice);
        const formattedPrice = formatPrice(data.ticker.price || data.ticker.lastPrice);
        
        const buyPriceElement = document.getElementById('currentPriceBuy');
        const sellPriceElement = document.getElementById('currentPriceSell');
        
        if (buyPriceElement) {
            buyPriceElement.textContent = formattedPrice;
            buyPriceElement.setAttribute('data-price', priceValue);
        }
        if (sellPriceElement) {
            sellPriceElement.textContent = formattedPrice;
            sellPriceElement.setAttribute('data-price', priceValue);
        }
        
        // Recalculer les coûts/revenus si des quantités sont entrées
        const buyQty = parseFloat(document.getElementById('buyQuantity').value) || 0;
        const sellQty = parseFloat(document.getElementById('sellQuantity').value) || 0;
        
        if (buyQty > 0) {
            document.getElementById('buyCost').textContent = `Coût: $${(buyQty * priceValue).toFixed(2)}`;
        }
        if (sellQty > 0) {
            document.getElementById('sellRevenue').textContent = `Revenu: $${(sellQty * priceValue).toFixed(2)}`;
        }
    }
}

// Modifier la fonction fetchLiveData existante pour inclure la mise à jour des prix de trading
const originalFetchLiveData = fetchLiveData;
fetchLiveData = async function() {
    await originalFetchLiveData();
    
    // Récupérer aussi les données pour le trading
    try {
        const response = await fetch(`/pairs/api/${SYMBOL}/?type=ticker`);
        if (response.ok) {
            const data = await response.json();
            updateTradingPrices(data);
        }
    } catch (error) {
        console.error('Erreur mise à jour prix trading:', error);
    }
};
</script>
{% endblock %}

